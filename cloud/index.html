<html>
<style type="text/css" media="screen">
    #editor { 
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        width: 665px;
        height: 625px;
        border: 1px solid #333;
    }

    .formLabel {
      display: inline-block;
      width: 5em;
      font-size: 1.15em;
      vertical-align: top;
    }

    .di {
      display: inline;
    }

    .helpButton {
      font-size: 1em;
      float: left;
      width: 5em;
    }

    .runMatch {
      font-size: 1em;
      float: right;
      width: 7em;
    }

    .botButton {
      font-size: 1em;
    }

    .botButtonList {
      margin-left: 1em;
    }

    .fileList {
      font-size: 1em;
      width: 9em;
    }
</style>
<head><title>BerryBots cloud demo</title></head>
<link href='https://fonts.googleapis.com/css?family=Ubuntu:regular' rel='stylesheet' type='text/css'>
<link rel="shortcut icon" href="favicon.gif">
<body style="font-family: Ubuntu, Arial, sans-serif;">

<script type="text/javascript">
function runMatch() {
  var x = new XMLHttpRequest();
  var params = 'stage=' + document.getElementById('Stage').value
      + '&opponent=' + document.getElementById('Opponent').value
      + '&code=' + encodeURI(editor.getValue()).replace(/\+/g, "%2B");
  x.open('POST', '/cgi-bin/runmatch.pl', true);
  x.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
  x.onreadystatechange = function () {
    if (x.readyState == 4) {
      var parser = new DOMParser();
      var xmlDoc = parser.parseFromString(x.responseText, 'application/xml');
      var player = document.getElementById('player');
      if (player == null) {
        player = document.createElement('iframe');
        player.id = 'player';
        player.style.width = '95%'; 
        player.style.height = '650px'; 
        document.getElementById('playerDiv').appendChild(player);       
      }
      window.location.hash = '';
      window.location.hash = 'player';
      var replayPath = '/replays/' + xmlDoc.getElementsByTagName('r')[0].childNodes[0].nodeValue;
      document.getElementById('replayUrl').value =
          'http://' + window.location.hostname + replayPath;
      player.src = replayPath;
    }
  };
  x.send(params);
}

function loadBot(filename) {
  var x = new XMLHttpRequest();
  x.open('GET', '/bots/' + filename, false);
  x.setRequestHeader('Content-Type', 'text/plain');
  x.onreadystatechange = function () {
    if (x.readyState == 4) {
      editor.setValue(x.responseText);
      editor.clearSelection();
      editor.scrollToLine(0);
      window.location.hash = '';
      window.location.hash = 'editor';
    }
  };
  x.send();
}

function onStageSelect() {
  var stage = document.getElementById('Stage').value;
  if (stage == 'maze2.lua') {
    selectBot('<none>');
  } else if (stage == 'battle1.lua') {
    var opponent = document.getElementById('Opponent').value;
    if (opponent == 'jouster.lua' || opponent == '<none>') {
      selectBot('randombot.lua');
    }
  }
}

function selectBot(filename) {
  var opponentSelect = document.getElementById('Opponent');
  for (var x = 0; x < opponentSelect.options.length; x++) {
    if (opponentSelect.options[x].text == filename) {
      opponentSelect.options[x].selected = true;
      return;
    }
  }
}

function openHelp() {
  window.open('help.html', 'help', 'titlebar=no,scrollbars=no,width=530,'
      + 'height=265,top=' + window.screenY + ',left=' + (window.screenX + 500));
}
</script>

<a name="editor"></a>
<div>
  <div id="editor">-- A ship control program.

ship = nil
world = nil
heading = nil
force = nil

function init(shipArg, worldArg)
  ship = shipArg
  world = worldArg
  ship:setName("Player")
  ship:setShipColor(255, 255, 0)
  ship:setLaserColor(255, 255, 255)
  ship:setThrusterColor(255, 255, 0)
  heading = math.random() * math.pi * 2
  force = world:constants().MAX_THRUSTER_FORCE / 4
end

function run(enemyShips, sensors)
  ship:fireThruster(heading, force)
end

function roundOver()

end

function gameOver()

end
</div>

  <div style="position: absolute; left: 690px;">
    <form>
      <div style="width: 15em">
        <div style="margin-bottom: 0.5em;">
          <div class="formLabel">Stage:</div>
          <div class="di">
            <select id="Stage" size="3" onchange="onStageSelect()" class="fileList">
              <option SELECTED value="joust.lua">Joust</option>
              <option value="battle1.lua">Battle</option>
              <option value="maze2.lua">Maze</option>
            </select>
          </div>
        </div>
        <div style="margin-bottom: 0.5em;">
          <div class="formLabel">Opponent:</div>
          <div class="di">
            <select id="Opponent" size="7" class="fileList">
              <option SELECTED value="jouster.lua">Jouster</option>
              <option value="floatingduck.lua">FloatingDuck</option>
              <option value="chaser.lua">Chaser</option>
              <option value="randombot.lua">RandomBot</option>
              <option value="wallhugger.lua">WallHugger</option>
              <option value="basicbattler.lua">BasicBattler</option>
              <option>&lt;none&gt;</option>
            </select>
          </div>
        </div>
        <div>
          <input type="button" class="helpButton" value="Help" onclick="openHelp()">
          <input type="button" class="runMatch" value="Run Match" onclick="runMatch()">
        </div>
      </div>
      <br><br><br>
      Start from:
      <div class="botButtonList">
        <input type="button" class="botButton" value="Default code" onclick="loadBot('player.lua')">
        <br><input type="button" class="botButton" value="Jouster's code" onclick="loadBot('jouster.lua')">
        <br><input type="button" class="botButton" value="Chaser's code" onclick="loadBot('chaser.lua')">
        <br><input type="button" class="botButton" value="RandomBot's code" onclick="loadBot('randombot.lua')">
        <br><input type="button" class="botButton" value="WallHugger's code" onclick="loadBot('wallhugger.lua')">
        <br><input type="button" class="botButton" value="BasicBattler's code" onclick="loadBot('basicbattler.lua')">
      </div>
      <br>
      BerryBots Lua API docs:
      <br>
      &nbsp;&nbsp;&nbsp;&nbsp;<a href="http://berrybots.com/apidoc/modules/ShipControl.html" target="_blank">ShipControl</a>
      &bull; <a href="http://berrybots.com/apidoc/modules/Ship.html" target="_blank">Ship</a>
      &bull; <a href="http://berrybots.com/apidoc/modules/World.html" target="_blank">World</a>
      &bull; <a href="http://berrybots.com/apidoc" target="_blank">all docs</a>
      <br><br>
      Powered by:
      <br>
      &nbsp;&nbsp;&nbsp;&nbsp;<a href="http://berrybots.com">BerryBots</a>
      &bull; <a href="http://ace.c9.io">Ace</a>
      &bull; <a href="http://kineticjs.com">KineticJS</a>
      <br><br>
      Replay URL: <input type="text" onMouseUp="return false" size="25" id="replayUrl" onfocus="this.select()">
    </form>
  </div>
</div>

<div id="playerDiv" style="position: absolute; top: 650px; width: 95%">
  <a name="player"></a>
</div>

<script src="ace.js" type="text/javascript" charset="utf-8"></script>
<script>
  var editor = ace.edit("editor");
  editor.getSession().setMode("ace/mode/lua");
  editor.setTheme("ace/theme/textmate");
  editor.getSession().setTabSize(2);
  editor.getSession().setUseSoftTabs(true);
  editor.setHighlightActiveLine(false);
</script>

</body>
</html>
