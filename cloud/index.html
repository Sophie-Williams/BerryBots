<html>
<style type="text/css" media="screen">
    #editor { 
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        width: 625px;
        height: 600px;
        border: 1px solid #333;
    }

    .formLabel {
      display: inline-block;
      width: 5em;
      font-size: 1.15em;
      vertical-align: top;
    }

    .di {
      display: inline;
    }

    .runMatch {
      font-size: 1.5em;
      width: 200px;
    }

    .fileList {
      font-size: 1em;
      width: 175px;
    }
</style>
<head><title>BerryBots Cloud demo</title></head>
<link href='https://fonts.googleapis.com/css?family=Ubuntu:regular' rel='stylesheet' type='text/css'>
<body style="font-family: Ubuntu, Arial, Tahoma, sans-serif;">

<script type="text/javascript">
function runMatch() {
  var x = new XMLHttpRequest();
  var params = 'stage=' + document.getElementById('Stage').value
      + '&opponent=' + document.getElementById('Opponent').value
      + '&code=' + encodeURI(editor.getValue()).replace(/\+/g, "%2B");
  x.open('POST', '/cgi-bin/runmatch.pl', true);
  x.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
  x.onreadystatechange = function () {
    if (x.readyState == 4) {
      var parser = new DOMParser();
      var xmlDoc = parser.parseFromString(x.responseText, 'application/xml');
      var player = document.getElementById('player');
      if (player == null) {
        player = document.createElement('iframe');
        player.id = 'player';
        player.style.width = '95%'; 
        player.style.height = '650px'; 
        document.getElementById('playerDiv').appendChild(player);       
      }
      window.location.hash = '';
      window.location.hash = 'player';
      player.src = '/replays/' + xmlDoc.getElementsByTagName('r')[0].childNodes[0].nodeValue;
    }
  };
  x.send(params);
}

function loadBot(filename) {
  var x = new XMLHttpRequest();
  x.open('GET', '/bots/' + filename, false);
  x.setRequestHeader('Content-Type', 'text/plain');
  x.onreadystatechange = function () {
    if (x.readyState == 4) {
      editor.setValue(x.responseText);
      editor.clearSelection();
      editor.scrollToLine(0);
      window.location.hash = '';
      window.location.hash = 'editor';
    }
  };
  x.send();
}

function onStageSelect() {
  var stage = document.getElementById('Stage').value;
  if (stage == 'maze2.lua') {
    selectBot('<none>');
  } else if (stage == 'battle1.lua') {
    var opponent = document.getElementById('Opponent').value;
    if (opponent == 'jouster.lua' || opponent == '<none>') {
      selectBot('randombot.lua');
    }
  }
}

function selectBot(filename) {
  var opponentSelect = document.getElementById('Opponent');
  for (var x = 0; x < opponentSelect.options.length; x++) {
    if (opponentSelect.options[x].text == filename) {
      opponentSelect.options[x].selected = true;
      return;
    }
  }
}
</script>

<a name="editor"></a>
<div>
  <div id="editor">-- A ship control program.

ship = nil
world = nil

function init(shipArg, worldArg)
  ship = shipArg
  world = worldArg
  ship:setName("Player")
  ship:setShipColor(255, 255, 0)
  ship:setLaserColor(255, 255, 255)
  ship:setThrusterColor(255, 255, 0)
end

local heading = math.random() * math.pi * 2
function run(enemyShips, sensors)
  ship:fireThruster(heading, 0.25)
end

function roundOver()

end

function gameOver()

end
  </div>

  <div style="position: absolute; left: 650px;">
    <form>
      <div>
        <div class="formLabel">Stage:</div>
        <div class="di">
          <select id="Stage" size="3" onchange="onStageSelect()" class="fileList">
            <option SELECTED>joust.lua</option>
            <option>battle1.lua</option>
            <option>maze2.lua</option>
          </select>
        </div>
      </div>
      <br>
      <div>
        <div class="formLabel">Opponent:</div>
        <div class="di">
          <select id="Opponent" size="7" class="fileList">
            <option SELECTED>jouster.lua</option>
            <option>chaser.lua</option>
            <option>randombot.lua</option>
            <option>wallhugger.lua</option>
            <option>basicbattler.lua</option>
            <option>floatingduck.lua</option>
            <option>&lt;none&gt;</option>
          </select>
        </div>
      </div>
      <br>
      <input type="button" class="runMatch" value="Run Match" onclick="runMatch()">
      <br><br><br>
      Start from:
      <br><input type="button" value="Default code" onclick="loadBot('player.lua')">
      <br><input type="button" value="Jouster's code" onclick="loadBot('jouster.lua')">
      <br><input type="button" value="Chaser's code" onclick="loadBot('chaser.lua')">
      <br><input type="button" value="RandomBot's code" onclick="loadBot('randombot.lua')">
      <br><input type="button" value="WallHugger's code" onclick="loadBot('wallhugger.lua')">
      <br><input type="button" value="BasicBattler's code" onclick="loadBot('basicbattler.lua')">
      <br><br>
      <a href="http://berrybots.com/apidoc" target="_blank">BerryBots API docs</a>
      <br><br>
      <a href="http://berrybots.com" target="_blank">BerryBots.com</a>
    </form>
  </div>
</div>

<div id="playerDiv" style="position: absolute; top: 625px; width: 95%">
  <a name="player"></a>
</div>

<script src="ace.js" type="text/javascript" charset="utf-8"></script>
<script>
  var editor = ace.edit("editor");
  editor.getSession().setMode("ace/mode/lua");
  editor.setTheme("ace/theme/textmate");
  editor.getSession().setTabSize(2);
  editor.getSession().setUseSoftTabs(true);
</script>

</body>
</html>
